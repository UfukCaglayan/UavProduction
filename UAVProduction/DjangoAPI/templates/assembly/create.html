<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Montaj ve Üretim</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <style>
        /* Toast mesaj stili */
        .toast-message {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
            z-index: 9999;
        }
        .toast-error {
            background-color: #dc3545;
        }

        /* Select genişlik ayarı */
        .select2-container {
            width: 100% !important;
        }
        select.form-control {
            width: 100% !important;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2>Montaj ve Uçak Üretimi</h2>

        <!-- Seçim Menüsü -->
        <div class="mb-4">
            <label for="process-select" class="form-label">İşlem Seçiniz</label>
            <select id="process-select" class="form-control">
                <option value="">Seçiniz</option>
                <option value="assembly_start">Montaj Başlangıcı</option>
                <option value="assembly_process">Monte ve Üretim</option>
            </select>
        </div>

        <!-- Montaj Başlangıcı Formu -->
        <form id="assembly-form" method="post" style="display: none;">
            {% csrf_token %}
            <div class="mb-3">
                <label for="uav" class="form-label">UAV Seçiniz</label>
                {{ assembly_form.uav }}
                <label  id="newAssemblyCode" style="display: none;" class="form-label"></label>
            </div>
            <button type="button" id="create-assembly-btn" class="btn btn-primary">Montaja Başla</button>
        </form>

        <!-- Monte İşlemi Bölümü -->
        <div id="assembly-section" style="display: none;">
            <form id="part-form" method="post" class="mt-3">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="assembly-select" class="form-label">Montaj Kodu Seçiniz</label>
                    {{ part_form.assembly }}  <!-- assembly alanını burada kontrol edin -->

                    <label  id="missing_part" style="display: none;" class="form-label"></label>

                </div>
                <div class="mb-3">
                    <label for="part-select" class="form-label">Parça Seçiniz</label>
        <select name="part_production" id="part_production" class="form-control">
            <!-- Başlangıçta boş olacak, JavaScript ile dolacak -->
        </select>
                </div>
                <button type="button" id="add-part-btn" class="btn btn-success">Ekle</button>

                <button type="button" id="complete-production-btn" class="btn btn-success">Üretimi Tamamla</button>
            </form>
        </div>

    </div>

    <!-- Toast Mesajı -->
    <div id="toast" class="toast-message"></div>

    <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js"></script>
    <script>
        $(document).ready(function () {
            $(document).ready(function() {

                $('#assembly-select').on('change', function() {
        var assemblyId = $(this).val();

        // Eğer bir montaj kodu seçildiysa, parçaları yüklemek için AJAX isteği gönderin
        if (assemblyId) {
    fetch(`/get_parts_for_assembly/${assemblyId}/`)
        .then(response => response.json())
        .then(data => {
            var partSelect = $('#part_production');
            partSelect.empty();  // Mevcut parçaları temizle

            // Yeni parçaları ekle
            data.parts.forEach(function(part) {
                var option = $('<option></option>').val(part.part_id).text(part.part_name);
                partSelect.append(option);
            });

            if (data.missing_parts.length > 0) {
                var missingPartsLabel = $('#missing_part');
                var missingPartsText = `${data.uav_name} için eksik parçalar:  `;
                
                // Eksik parçaları listele
                data.missing_parts.forEach(function(missing_part) {
                    missingPartsText += `${missing_part}, `;
                });

                // Son virgülü kaldır
                missingPartsLabel.text(missingPartsText.slice(0, -2));  
                missingPartsLabel.show();
            } else {
                $('#missing_part').hide();
            }
        })
        .catch(error => console.error('Error:', error));
}
    });

    $('.select2').select2({
        placeholder: "Bir seçenek seçin",
        allowClear: true,
        width: '100%'  // Select2'nin genişliğini kontrol edin
    });
    $('#id_uav').select2({
        placeholder: "Seçiniz",  // Placeholder metni
        allowClear: true,
        width: '100%'
    });

});

            // İşlem seçimine göre bölümleri göster
            $('#process-select').on('change', function () {
                const selectedValue = $(this).val();
                $('#assembly-form, #assembly-section').hide(); // Tüm bölümleri gizle

                if (selectedValue === 'assembly_start') {
                    $('#assembly-form').show(); // Montaj başlangıcı formunu göster
                } else if (selectedValue === 'assembly_process') {
                    $('#assembly-section').show(); // Montaj süreci formunu göster
                }
            });

            // Montaj başlangıcı işlemi
            $('#create-assembly-btn').on('click', function () {
                const formData = $('#assembly-form').serialize();
                $.post('', formData + '&create_assembly=true', function (response) {
                    if (response.success) {
                        // Yeni montaj kodunu ekleyin
                        const newOption = new Option(response.assembly_code, response.assembly_id, false, false);
                        $('#assembly-select').append(newOption).trigger('change');
                        $('#newAssemblyCode').text('Montaj Kodu: ' + response.assembly_code).css('display', 'block');
                        showToast('Montaj başarıyla başlatıldı!');  // Başarı mesajı
                    } else {
                        showToast('Bir hata oluştu!', true);  // Hata mesajı
                    }
                });
            });

            // Monte işlemi - parça ekleme
            $('#add-part-btn').on('click', function () {
                const formData = $('#part-form').serialize();
                $.post('', formData + '&add_part=true', function (response) {
                    if (response.success) {
                        showToast('Parça başarıyla eklendi!');  // Başarı mesajı
                    } else {
                        showToast('Parça eklenirken bir hata oluştu!', true);  // Hata mesajı
                    }
                });
            });

            $('#complete-production-btn').on('click', function () {
    const formData = $('#part-form').serialize();  // Form verilerini al
    $.post('', formData + '&complete_production=true', function (response) {
        if (response.success) {
            showToast('Üretim başarıyla tamamlandı!');  // Başarı mesajı
        } else {
            showToast('Üretim tamamlanırken bir hata oluştu!', true);  // Hata mesajı
        }
    });
});
        });

        // Toast mesajını göster
        function showToast(message, isError = false) {
            const toast = $('#toast');
            toast.text(message);
            if (isError) {
                toast.addClass('toast-error');
            } else {
                toast.removeClass('toast-error');
            }
            toast.fadeIn(300).delay(3000).fadeOut(300);
        }

      
    </script>
</body>
</html>
